openapi: 3.0.3
info:
  title: Builder API
  version: 1.0.0
  description: API documentation for the Builder backend (accounts, items, item categories, maps).
servers:
  - url: http://localhost:5001

components:
  schemas:
    SignupRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
    SigninRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
    AccountResponse:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
    Item:
      type: object
      properties:
        id:
          type: string
        category:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
        name:
          type: string
        description:
          type: string
        price:
          type: number
          format: float
        sizeX:
          type: integer
        sizeY:
          type: integer
        imageUrl:
          type: string
          description: >-
            URL or local asset path for the item's image. Two common forms are
            1) a fully-qualified remote URL (e.g. https://cdn.example.com/..)
            2) a bundled/local path that your frontend may resolve, for example
               '../../assets/images/shop/road-axis-x.png' or '/assets/images/shop/road-axis-x.png'.
            Frontend clients should attempt to use the value as a remote `uri` if it
            begins with 'http'; otherwise they may map known local paths to bundled
            assets or request the asset via the `/assets` route documented below.
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    ItemCategory:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
    AccountDetail:
      type: object
      properties:
        id:
          type: string
        gameName:
          type: string
        chron:
          type: number
        exp:
          type: number
        createdAt:
          type: string
          format: date-time
    GameNameUpdate:
      type: object
      required: [gameName]
      properties:
        gameName:
          type: string
    Map:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        account:
          type: object
          properties:
            id:
              type: string
        widthTiles:
          type: integer
        heightTiles:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    PlacementSimplified:
      type: object
      properties:
        id:
          type: string
        x:
          type: integer
        y:
          type: integer
        item:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            imageUrl:
              type: string
            sizeX:
              type: integer
            sizeY:
              type: integer
            price:
              type: number
              format: float
        placedBy:
          type: object
          properties:
            id:
              type: string
        placedAt:
          type: string
          format: date-time
    MapWithGrid:
      type: object
      properties:
        map:
          $ref: "#/components/schemas/Map"
        grid:
          type: array
          description: "2D array (rows = Y) of placement objects or null for empty tiles"
          items:
            type: array
            items:
              anyOf:
                - $ref: "#/components/schemas/PlacementSimplified"
                - type: "null"

paths:
  /api/account/signup:
    post:
      tags: [account]
      summary: Create a new account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupRequest"
      responses:
        "201":
          description: Account created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  account:
                    $ref: "#/components/schemas/AccountResponse"
        "400":
          description: Validation error

  /api/account/signin:
    post:
      tags: [account]
      summary: Sign in and receive tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SigninRequest"
      responses:
        "200":
          description: Signed in
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  account:
                    $ref: "#/components/schemas/AccountResponse"
                  tokens:
                    type: object
                    properties:
                      access:
                        type: string
                      refresh:
                        type: string

  /api/account/signout:
    post:
      tags: [account]
      summary: Sign out the current session
      responses:
        "200":
          description: Signed out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "400":
          description: Cannot sign out

  /api/items:
    get:
      tags: [items]
      summary: List active items (shop)
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: Paginated items
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    type: integer
                  limit:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Item"
    post:
      tags: [items]
      summary: Create an item
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                category:
                  type: string
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                sizeX:
                  type: integer
                sizeY:
                  type: integer
                imageUrl:
                  type: string
      responses:
        "201":
          description: Created item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Item"

  /api/items/buy:
    post:
      tags: [items]
      summary: Buy an item from the shop and place it on the map
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                [accountId, accountDetailsId, mapId, x, y, itemId]
              properties:
                accountId:
                  type: string
                accountDetailsId:
                  type: string
                mapId:
                  type: string
                x:
                  type: integer
                y:
                  type: integer
                itemId:
                  type: string
      responses:
        "200":
          description: Item purchased and placed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  item:
                    $ref: "#/components/schemas/Item"
        "400":
          description: Validation error or insufficient chrons
        "404":
          description: Item not found

  /api/items/sell:
    post:
      tags: [items]
      summary: Sell a placed item back to the shop
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                [accountId, accountDetailsId, mapId, x, y]
              properties:
                accountId:
                  type: string
                accountDetailsId:
                  type: string
                mapId:
                  type: string
                x:
                  type: integer
                y:
                  type: integer
      responses:
        "200":
          description: Item sold and refund issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  refund:
                    type: integer
        "400":
          description: Account detail not found
        "404":
          description: Placement not found

  /api/items/move:
    post:
      tags: [items]
      summary: Move an existing placement to a new tile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [accountId, mapId, fromX, fromY, toX, toY]
              properties:
                accountId:
                  type: string
                mapId:
                  type: string
                fromX:
                  type: integer
                fromY:
                  type: integer
                toX:
                  type: integer
                toY:
                  type: integer
      responses:
        "200":
          description: Placement moved
        "400":
          description: Destination occupied
        "403":
          description: Not owner of placement
        "404":
          description: Placement not found

  /api/items/{id}:
    get:
      tags: [items]
      summary: Get item by id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Item"
        "404":
          description: Not found
    put:
      tags: [items]
      summary: Update item
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated item
    delete:
      tags: [items]
      summary: Soft-delete item (sets isActive=false)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Soft deleted

  /api/item-categories:
    get:
      tags: [categories]
      summary: List item categories
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: Paginated categories
    post:
      tags: [categories]
      summary: Create a category
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        "201":
          description: Created

  /api/item-categories/{id}:
    get:
      tags: [categories]
      summary: Get category by id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Category
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemCategory"
        "404":
          description: Not found
    put:
      tags: [categories]
      summary: Update category
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated
    delete:
      tags: [categories]
      summary: Soft-delete category (isActive=false)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Soft deleted
  /api/account-detail/account/{accountId}/game-name:
    put:
      tags: [account]
      summary: Update account detail's gameName by account id
      parameters:
        - in: path
          name: accountId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GameNameUpdate"
      responses:
        "200":
          description: Updated account detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "404":
          description: Account or detail not found

  /api/account-detail/{id}/game-name:
    put:
      tags: [account]
      summary: Update account detail's gameName by detail id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GameNameUpdate"
      responses:
        "200":
          description: Updated account detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "404":
          description: Not found

  /api/account-detail/{id}:
    get:
      tags: [account]
      summary: Get account detail by id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Account detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "404":
          description: Not found

  /api/account-detail/{id}/chron:
    post:
      tags: [account]
      summary: Add chron (minutes) to an account detail
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [minutes]
              properties:
                minutes:
                  type: integer
      responses:
        "200":
          description: Updated account detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "400":
          description: Invalid minutes value
        "404":
          description: Account detail not found

  /api/account-detail/{id}/profile-image:
    post:
      tags: [account]
      summary: Upload or replace account profile image
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
      responses:
        "200":
          description: Updated account detail with image URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "400":
          description: Validation or upload error
        "404":
          description: Account detail not found

  /api/account-detail/{id}/avatar:
    put:
      tags: [account]
      summary: Set a bundled avatar image for the account
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [imageUrl]
              properties:
                imageUrl:
                  type: string
                  description: "Bundled filename, e.g. '1.png'..'5.png'"
      responses:
        "200":
          description: Updated account detail with avatar
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "400":
          description: Invalid avatar
        "404":
          description: Account detail not found

  /api/maps/{id}:
    get:
      tags: [maps]
      summary: Get map by id along with a 2D tile grid
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Map with tile grid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MapWithGrid"
        "404":
          description: Map not found

    post:
      tags: [maps]
      summary: Expand a map's tile dimensions by 1x1, spending chrons
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [accountDetailsId]
              properties:
                accountDetailsId:
                  type: string
                  description: ID of the AccountDetail that will pay the expansion cost
      responses:
        "200":
          description: Map expanded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  map:
                    $ref: "#/components/schemas/Map"
                  accountDetail:
                    $ref: "#/components/schemas/AccountDetail"
        "400":
          description: Invalid request or insufficient chrons
        "404":
          description: Map not found

  /api/maps/{id}/name:
    put:
      tags: [maps]
      summary: Update a map's name
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        "200":
          description: Updated map
          content:
            application/json:
              schema:
                type: object
                properties:
                  map:
                    $ref: "#/components/schemas/Map"
        "400":
          description: Validation error
        "404":
          description: Map not found

  /api/maps/account/{accountId}:
    get:
      tags: [maps]
      summary: List maps for a given account id
      parameters:
        - in: path
          name: accountId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Maps belonging to the account
          content:
            application/json:
              schema:
                type: object
                properties:
                  maps:
                    type: array
                    items:
                      $ref: "#/components/schemas/Map"
        "404":
          description: Account not found
        "500":
          description: Server error

tags:
  - name: account
  - name: items
  - name: categories
  - name: maps

# Static assets served by the backend for convenience. Example uses:
# - /assets/images/shop/road-axis-x.png
# Clients can request the file directly as an image.
  /assets/images/{fileName}:
    get:
      summary: Serve a static image asset from the server's bundled frontend assets folder
      parameters:
        - in: path
          name: fileName
          required: true
          schema:
            type: string
          description: File name (including subpath under `images/`), for example `shop/road-axis-x.png` or `road-connectors/default-tile.png`.
      responses:
        "200":
          description: Image file returned (content-type will vary by file extension)
          content:
            image/png: {}
            image/jpeg: {}
            image/svg+xml: {}
        "404":
          description: Not found
        "500":
          description: Server error
